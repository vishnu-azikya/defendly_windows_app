import React, { useMemo } from 'react';
import { View, Text, StyleSheet, useColorScheme } from 'react-native';
import { useReport } from '../../context/ReportContext';

const VulnerabilitySummaryCard = () => {
  const isDark = useColorScheme() === 'dark';
  const { reportData, isLoading, error } = useReport();

  // Calculate severity counts from Report Context
  const severityCounts = useMemo(() => {
    if (!reportData) {
      return {
        critical: 0,
        high: 0,
        medium: 0,
        low: 0,
        info: 0,
      };
    }

    const results =
      reportData?.get_reports_response?.report?.report?.results?.result || [];

    // Handle single object vs array
    const resultsArray = Array.isArray(results)
      ? results
      : results
      ? [results]
      : [];

    const counts = {
      critical: 0,
      high: 0,
      medium: 0,
      low: 0,
      info: 0,
    };

    resultsArray.forEach((result) => {
      const cvss = parseFloat(result.severity || '0');

      // Map CVSS score to severity level
      if (cvss > 9.0) {
        counts.critical++;
      } else if (cvss > 7.0) {
        counts.high++;
      } else if (cvss > 4.0) {
        counts.medium++;
      } else if (cvss > 0) {
        counts.low++;
      } else {
        counts.info++;
      }
    });

    return counts;
  }, [reportData]);

  const total = Object.values(severityCounts).reduce(
    (sum, count) => sum + count,
    0
  );

  const getRiskMessage = () => {
    const critical = severityCounts['critical'] || 0;
    const high = severityCounts['high'] || 0;
    if (critical > 0) return 'High Risk - Immediate Attention Required';
    if (high > 0) return 'Moderate Risk - Action Needed';
    return 'Low Risk - Monitor';
  };

  const getRiskMessageColor = () => {
    const msg = getRiskMessage();
    if (msg.includes('High')) return '#dc2626';
    if (msg.includes('Moderate')) return '#f59e42';
    return '#22c55e';
  };

  // Error state
  if (error && !reportData) {
    return (
      <View style={[styles.container, isDark && styles.containerDark]}>
        <Text style={[styles.errorText, isDark && styles.errorTextDark]}>
          No data available
        </Text>
      </View>
    );
  }

  // Loading state
  if (isLoading && !reportData) {
    return (
      <View style={[styles.container, isDark && styles.containerDark]}>
        <Text style={[styles.loadingText, isDark && styles.loadingTextDark]}>
          Loading vulnerability data...
        </Text>
      </View>
    );
  }

  const cards = [
    {
      label: 'Total Vulnerabilities',
      value: total,
      color: '#FF0000',
      bgColor: 'rgba(255, 0, 0, 0.8)',
      isTotal: true,
    },
    {
      label: 'Critical',
      value: severityCounts['critical'] || 0,
      color: '#7f1d1d',
      borderColor: '#7f1d1d',
      trend: severityCounts['critical'] > 0 ? '●' : '-',
    },
    {
      label: 'High',
      value: severityCounts['high'] || 0,
      color: '#dc2626',
      borderColor: '#dc2626',
      trend: severityCounts['high'] > 0 ? '●' : '-',
    },
    {
      label: 'Medium',
      value: severityCounts['medium'] || 0,
      color: '#fbbf24',
      borderColor: '#fbbf24',
      trend: severityCounts['medium'] > 0 ? '●' : '-',
    },
    {
      label: 'Low',
      value: severityCounts['low'] || 0,
      color: '#16a34a',
      borderColor: '#16a34a',
      trend: severityCounts['low'] > 0 ? '●' : '-',
    },
    {
      label: 'Info',
      value: severityCounts['info'] || 0,
      color: '#0ea5e9',
      borderColor: '#0ea5e9',
      trend: severityCounts['info'] > 0 ? '●' : '-',
    },
  ];

  return (
    <View style={[styles.container, isDark && styles.containerDark]}>
      <View style={styles.grid}>
        {/* First Row */}
        <View style={styles.row}>
          {/* Total Vulnerabilities - Large Card */}
          <View
            style={[
              styles.card,
              styles.totalCard,
              { backgroundColor: '#FF0000' },
            ]}
          >
            <Text style={styles.labelWhite}>{cards[0].label}</Text>
            <View style={styles.bottomRow}>
              <View style={styles.spacer} />
              <Text style={styles.valueWhite}>{cards[0].value}</Text>
            </View>
          </View>

          {/* Critical Card */}
          <View
            style={[
              styles.card,
              styles.severityCard,
              {
                borderWidth: 2,
                borderColor: cards[1].borderColor,
                backgroundColor: isDark ? '#202020' : '#ffffff',
              },
            ]}
          >
            <Text
              style={[
                styles.label,
                isDark && styles.labelDark,
              ]}
            >
              {cards[1].label}
            </Text>
            <View style={styles.bottomRow}>
              {cards[1].trend && (
                <Text style={[styles.trend, { color: '#f97316' }]}>
                  {cards[1].trend}
                </Text>
              )}
              <Text
                style={[
                  styles.value,
                  isDark && styles.valueDark,
                ]}
              >
                {cards[1].value}
              </Text>
            </View>
          </View>

          {/* High Card */}
          <View
            style={[
              styles.card,
              styles.severityCard,
              {
                borderWidth: 2,
                borderColor: cards[2].borderColor,
                backgroundColor: isDark ? '#202020' : '#ffffff',
              },
            ]}
          >
            <Text
              style={[
                styles.label,
                isDark && styles.labelDark,
              ]}
            >
              {cards[2].label}
            </Text>
            <View style={styles.bottomRow}>
              {cards[2].trend && (
                <Text style={[styles.trend, { color: '#f97316' }]}>
                  {cards[2].trend}
                </Text>
              )}
              <Text
                style={[
                  styles.value,
                  isDark && styles.valueDark,
                ]}
              >
                {cards[2].value}
              </Text>
            </View>
          </View>
        </View>

        {/* Second Row */}
        <View style={styles.row}>
          {/* Medium Card */}
          <View
            style={[
              styles.card,
              styles.severityCard,
              {
                borderWidth: 2,
                borderColor: cards[3].borderColor,
                backgroundColor: isDark ? '#202020' : '#ffffff',
              },
            ]}
          >
            <Text
              style={[
                styles.label,
                isDark && styles.labelDark,
              ]}
            >
              {cards[3].label}
            </Text>
            <View style={styles.bottomRow}>
              {cards[3].trend && (
                <Text style={[styles.trend, { color: '#f97316' }]}>
                  {cards[3].trend}
                </Text>
              )}
              <Text
                style={[
                  styles.value,
                  isDark && styles.valueDark,
                ]}
              >
                {cards[3].value}
              </Text>
            </View>
          </View>

          {/* Low Card */}
          <View
            style={[
              styles.card,
              styles.severityCard,
              {
                borderWidth: 2,
                borderColor: cards[4].borderColor,
                backgroundColor: isDark ? '#202020' : '#ffffff',
              },
            ]}
          >
            <Text
              style={[
                styles.label,
                isDark && styles.labelDark,
              ]}
            >
              {cards[4].label}
            </Text>
            <View style={styles.bottomRow}>
              {cards[4].trend && (
                <Text style={[styles.trend, { color: '#f97316' }]}>
                  {cards[4].trend}
                </Text>
              )}
              <Text
                style={[
                  styles.value,
                  isDark && styles.valueDark,
                ]}
              >
                {cards[4].value}
              </Text>
            </View>
          </View>

          {/* Info Card */}
          <View
            style={[
              styles.card,
              styles.severityCard,
              {
                borderWidth: 2,
                borderColor: cards[5].borderColor,
                backgroundColor: isDark ? '#202020' : '#ffffff',
              },
            ]}
          >
            <Text
              style={[
                styles.label,
                isDark && styles.labelDark,
              ]}
            >
              {cards[5].label}
            </Text>
            <View style={styles.bottomRow}>
              {cards[5].trend && (
                <Text style={[styles.trend, { color: '#f97316' }]}>
                  {cards[5].trend}
                </Text>
              )}
              <Text
                style={[
                  styles.value,
                  isDark && styles.valueDark,
                ]}
              >
                {cards[5].value}
              </Text>
            </View>
          </View>
        </View>
      </View>

      {/* Risk Message */}
      <View style={styles.riskMessageContainer}>
        <Text style={[styles.riskMessage, { color: getRiskMessageColor() }]}>
          {getRiskMessage()}
        </Text>
      </View>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    backgroundColor: '#ffffff',
    borderRadius: 10,
    borderWidth: 1,
    borderColor: '#e5e5e5',
    padding: 16,
  },
  containerDark: {
    backgroundColor: '#202020',
    borderColor: '#232323',
  },
  grid: {
    gap: 12,
  },
  row: {
    flexDirection: 'row',
    gap: 12,
  },
  card: {
    borderRadius: 10,
    padding: 12,
    justifyContent: 'space-between',
    minHeight: 100,
  },
  totalCard: {
    flex: 1.2,
    backgroundColor: '#FF0000',
  },
  severityCard: {
    flex: 1,
  },
  label: {
    fontSize: 15,
    fontWeight: '500',
    color: '#111',
    marginBottom: 8,
  },
  labelWhite: {
    color: '#ffffff',
  },
  labelDark: {
    color: '#ffffff',
  },
  bottomRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'flex-end',
    marginTop: 'auto',
  },
  trend: {
    fontSize: 14,
    fontWeight: '600',
  },
  spacer: {
    flex: 1,
  },
  value: {
    fontSize: 32,
    fontWeight: '700',
    color: '#111',
  },
  valueWhite: {
    color: '#ffffff',
    fontSize: 32,
    fontWeight: '700',
  },
  valueDark: {
    color: '#ffffff',
  },
  riskMessageContainer: {
    marginTop: 16,
    paddingTop: 16,
    borderTopWidth: 1,
    borderTopColor: '#e5e5e5',
  },
  riskMessage: {
    fontSize: 14,
    fontWeight: '600',
  },
  errorText: {
    color: '#dc2626',
    textAlign: 'center',
    padding: 20,
  },
  errorTextDark: {
    color: '#ef4444',
  },
  loadingText: {
    color: '#666',
    textAlign: 'center',
    padding: 20,
  },
  loadingTextDark: {
    color: '#999',
  },
});

export default VulnerabilitySummaryCard;

